<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Regex.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Klojang Templates</a> &gt; <a href="index.source.html" class="el_package">org.klojang.templates.x.parse</a> &gt; <span class="el_source">Regex.java</span></div><h1>Regex.java</h1><pre class="source lang-java linenums">package org.klojang.templates.x.parse;

import org.klojang.check.Check;
import org.klojang.check.ObjectCheck;
import org.klojang.templates.ParseException;

import java.util.Set;
import java.util.regex.Pattern;

import static java.util.regex.Pattern.compile;
import static java.util.stream.Collectors.toSet;
import static org.klojang.check.CommonChecks.EQ;
import static org.klojang.check.CommonChecks.blank;

public final class Regex {

  private static final String REGEX_CMT_START = &quot;&lt;!--\\s*&quot;;
  private static final String REGEX_CMT_END = &quot;\\s*--&gt;&quot;;

  private static final String REGEX_VAR_GROUP_PREFIX = &quot;([a-zA-Z][a-zA-Z0-9_\\-]*)&quot;;

  private static final String REGEX_SEGMENT = &quot;(([a-zA-Z_]\\w*)|\\d+)&quot;;
  private static final String REGEX_PATH
      = &quot;(&quot;
      + REGEX_SEGMENT
      + &quot;(\\.&quot; + REGEX_SEGMENT + &quot;)*&quot;
      + &quot;)&quot;;

  private static final String REGEX_VARIABLE
      = &quot;~%&quot;
      + &quot;(&quot; + REGEX_VAR_GROUP_PREFIX + &quot;:)?&quot;
      + REGEX_PATH
      + &quot;%&quot;;

  private static final String REGEX_CMT_VARIABLE
      = REGEX_CMT_START
      + REGEX_VARIABLE
      + REGEX_CMT_END;
<span class="fc" id="L39">  public static final Pattern CMT_VARIABLE = compile(REGEX_CMT_VARIABLE);</span>
<span class="fc" id="L40">  public static final Pattern VARIABLE = compile(REGEX_VARIABLE);</span>
  private static final String ERR_ILLEGAL_VAL = &quot;Illegal value for system property %s: \&quot;%s\&quot;&quot;;
  private static final String ERR_IDENTICAL = &quot;varStart and tmplStart must be different&quot;;

  public static final String VAR_START = &quot;~%&quot;;
  public static final String VAR_END = &quot;%&quot;;
  public static final String TMPL_START = &quot;~%%&quot;;
  public static final String TMPL_END = VAR_END;

  public static final String PLACEHOLDER_START_END = &quot;&lt;!--%--&gt;&quot;;

  private static Regex instance;

  public static Regex of() throws ParseException {
<span class="fc bfc" id="L54" title="All 2 branches covered.">    if (instance == null) {</span>
<span class="fc" id="L55">      return instance = new Regex();</span>
    }
<span class="fc" id="L57">    return instance;</span>
  }

  public final Pattern variable;
  public final Pattern cmtVariable;
  public final Pattern beginTag;
  public final Pattern endTag;
  public final Pattern inlineTemplate;
  public final Pattern cmtInlineTemplate;
  public final Pattern includedTemplate;
  public final Pattern cmtIncludedTemplate;
  public final Pattern ditchTag;
  public final Pattern ditchBlock;
  public final Pattern placeholder;

<span class="fc" id="L72">  private Regex() throws ParseException {</span>

<span class="fc" id="L74">    checkSysProps();</span>

<span class="fc" id="L76">    String vStart = quote(VAR_START);</span>
<span class="fc" id="L77">    String vEnd = quote(VAR_END);</span>
<span class="fc" id="L78">    String tStart = quote(TMPL_START);</span>
<span class="fc" id="L79">    String tEnd = quote(TMPL_END);</span>

<span class="fc" id="L81">    String varGroupPrefix = &quot;([a-zA-Z_]\\w*)&quot;;</span>
<span class="fc" id="L82">    String identifier = &quot;[a-zA-Z0-9_\\-\\.]+&quot;;</span>

<span class="fc" id="L84">    String name = &quot;([a-zA-Z0-9_\\.\\-]+)&quot;;</span>

<span class="fc" id="L86">    String cmtStart = &quot;&lt;!--\\s*&quot;;</span>

<span class="fc" id="L88">    String cmtEnd = &quot;\\s*--&gt;&quot;;</span>

    //String ptnVariable = vStart + &quot;(&quot; + name + &quot;:)?(.+?)&quot; + vEnd;
<span class="fc" id="L91">    String ptnVariable = &quot;~%(([a-zA-Z_]\\w*):)?([a-zA-Z0-9_\\.\\-]+)%&quot;;</span>
<span class="fc" id="L92">    String ptnCmtVariable = cmtStart + ptnVariable + cmtEnd;</span>

<span class="fc" id="L94">    String ptnInlineBegin = tStart + &quot;begin:&quot; + name + tEnd;</span>

<span class="fc" id="L96">    String ptnInlineEnd = tStart + &quot;end:&quot; + name + tEnd;</span>

<span class="fc" id="L98">    String ptnInlineTmpl = ptnInlineBegin + &quot;(.*?)&quot; + tStart + &quot;end:\\1&quot; + tEnd;</span>

<span class="fc" id="L100">    String ptnCmtInlineTmpl =</span>
        cmtStart
            + ptnInlineBegin
            + cmtEnd
            + &quot;(.*?)&quot;
            + cmtStart
            + tStart
            + &quot;end:\\1&quot;
            + tEnd
            + cmtEnd;

<span class="fc" id="L111">    String ptnIncludedTmpl = tStart + &quot;include:(&quot; + name + &quot;:)?(.+?)&quot; + tEnd;</span>

<span class="fc" id="L113">    String ptnCmtIncludedTmpl = cmtStart + ptnIncludedTmpl + cmtEnd;</span>

<span class="fc" id="L115">    String ptnDitchTag = &quot;&lt;!--%%(.*?)--&gt;&quot;;</span>

<span class="fc" id="L117">    String ptnDitchBlock = ptnDitchTag + &quot;(.*?)&quot; + ptnDitchTag;</span>

<span class="fc" id="L119">    String ptnPlaceholder = PLACEHOLDER_START_END + &quot;(.*?)&quot; + PLACEHOLDER_START_END;</span>

    // Equivalent to prefixing the regular expression with &quot;(?ms)&quot;
<span class="fc" id="L122">    int msModifiers = Pattern.MULTILINE | Pattern.DOTALL;</span>

<span class="fc" id="L124">    this.variable = compile(ptnVariable);</span>
<span class="fc" id="L125">    this.cmtVariable = compile(ptnCmtVariable);</span>
<span class="fc" id="L126">    this.beginTag = compile(ptnInlineBegin);</span>
<span class="fc" id="L127">    this.endTag = compile(ptnInlineEnd);</span>
<span class="fc" id="L128">    this.inlineTemplate = compile(ptnInlineTmpl, msModifiers);</span>
<span class="fc" id="L129">    this.cmtInlineTemplate = compile(ptnCmtInlineTmpl, msModifiers);</span>
<span class="fc" id="L130">    this.includedTemplate = compile(ptnIncludedTmpl);</span>
<span class="fc" id="L131">    this.cmtIncludedTemplate = compile(ptnCmtIncludedTmpl);</span>
<span class="fc" id="L132">    this.ditchTag = compile(ptnDitchTag);</span>
<span class="fc" id="L133">    this.ditchBlock = compile(ptnDitchBlock, msModifiers);</span>
<span class="fc" id="L134">    this.placeholder = compile(ptnPlaceholder, msModifiers);</span>
<span class="fc" id="L135">  }</span>

  private static void checkSysProps() throws ParseException {
<span class="fc" id="L138">    checkThat(VAR_START).isNot(blank(), ERR_ILLEGAL_VAL, VAR_START);</span>
<span class="fc" id="L139">    checkThat(VAR_END).isNot(blank(), ERR_ILLEGAL_VAL, VAR_END);</span>
<span class="fc" id="L140">    checkThat(TMPL_START)</span>
<span class="fc" id="L141">        .isNot(blank(), ERR_ILLEGAL_VAL, TMPL_START)</span>
<span class="fc" id="L142">        .isNot(EQ(), VAR_START, ERR_IDENTICAL);</span>
<span class="fc" id="L143">    checkThat(TMPL_END).isNot(blank(), ERR_ILLEGAL_VAL, TMPL_END);</span>
<span class="fc" id="L144">  }</span>

  public void printAll() {
<span class="fc" id="L147">    System.out.println(&quot;VARIABLE .......: &quot; + variable);</span>
<span class="fc" id="L148">    System.out.println(&quot;VARIABLE_CMT ...: &quot; + cmtVariable);</span>
<span class="fc" id="L149">    System.out.println(&quot;NESTED .........: &quot; + inlineTemplate);</span>
<span class="fc" id="L150">    System.out.println(&quot;NESTED_CMT .....: &quot; + cmtInlineTemplate);</span>
<span class="fc" id="L151">    System.out.println(&quot;INCLUDE ........: &quot; + includedTemplate);</span>
<span class="fc" id="L152">    System.out.println(&quot;INCLUDE_CMT ....: &quot; + cmtIncludedTemplate);</span>
<span class="fc" id="L153">    System.out.println(&quot;DITCH_BLOCK: ...: &quot; + ditchBlock);</span>
<span class="fc" id="L154">    System.out.println(&quot;PLACEHOLDER: ...: &quot; + placeholder);</span>
<span class="fc" id="L155">  }</span>

  private static ObjectCheck&lt;String, ParseException&gt; checkThat(String sysprop) {
<span class="fc" id="L158">    return Check.on(ParseException::new, sysprop);</span>
  }

  private static String quote(String token) {
<span class="fc" id="L162">    String special = &quot;\\^$.|?*+()[]{}&quot;;</span>
<span class="fc" id="L163">    Set&lt;Integer&gt; specialChars = special.codePoints().boxed().collect(toSet());</span>
<span class="fc" id="L164">    Set&lt;Integer&gt; tokenChars = token.codePoints().boxed().collect(toSet());</span>
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">    return tokenChars.stream().anyMatch(specialChars::contains)</span>
<span class="nc" id="L166">        ? Pattern.quote(token)</span>
<span class="fc" id="L167">        : token;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>