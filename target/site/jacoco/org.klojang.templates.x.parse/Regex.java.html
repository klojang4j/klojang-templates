<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Regex.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Klojang Templates</a> &gt; <a href="index.source.html" class="el_package">org.klojang.templates.x.parse</a> &gt; <span class="el_source">Regex.java</span></div><h1>Regex.java</h1><pre class="source lang-java linenums">package org.klojang.templates.x.parse;

import org.klojang.check.Check;
import org.klojang.check.ObjectCheck;
import org.klojang.templates.ParseException;

import java.util.Set;
import java.util.regex.Pattern;

import static java.util.regex.Pattern.compile;
import static java.util.stream.Collectors.toSet;
import static org.klojang.check.CommonChecks.EQ;
import static org.klojang.check.CommonChecks.blank;

public final class Regex {

  private static final int MULTILINE = Pattern.MULTILINE | Pattern.DOTALL;

  private static final String REGEX_CMT_START = &quot;&lt;!--\\s*&quot;;
  private static final String REGEX_CMT_END = &quot;\\s*--&gt;&quot;;

  /**
   * Regular expression for inline group name prefixes, as in: ~%prefix:varname%.
   */
  private static final String REGEX_PREFIX = &quot;([a-zA-Z][a-zA-Z0-9_\\-]*)&quot;;

  private static final String REGEX_NAME = &quot;([a-zA-Z0-9_\\-]+)&quot;;
  private static final String REGEX_PATH
      = &quot;(&quot;
      + REGEX_NAME
      + &quot;(\\.&quot; + REGEX_NAME + &quot;)*&quot;
      + &quot;)&quot;;

  private static final String REGEX_VARIABLE
      = &quot;~%&quot;
      + &quot;(&quot; + REGEX_PREFIX + &quot;:)?&quot;
      + REGEX_PATH
      + &quot;%&quot;;

  private static final String REGEX_CMT_VARIABLE
      = REGEX_CMT_START
      + REGEX_VARIABLE
      + REGEX_CMT_END;
  private static final String REGEX_INLINE_TEMPLATE
      = &quot;~%%begin:&quot; + REGEX_NAME + &quot;%&quot;
      + &quot;(.*?)&quot;
      + &quot;~%%end:\\1%&quot;;

  private static final String REGEX_CMT_INLINE_TEMPLATE
      = REGEX_CMT_START
      + REGEX_INLINE_TEMPLATE
      + REGEX_CMT_END;

  private static final String REGEX_INCLUDE_PATH
      = &quot;([a-zA-Z0-9_~:;/?#!$&amp;%,@+.=\\-\\[\\]\\(\\)]+?)&quot;;

  private static final String REGEX_INCLUDED_TEMPLATE
      = &quot;~%%include:&quot;
      + &quot;(&quot; + REGEX_NAME + &quot;:)?&quot;
      + REGEX_INCLUDE_PATH
      + &quot;%%&quot;;

  private static final String CMT_REGEX_INCLUDED_TEMPLATE
      = REGEX_CMT_START
      + REGEX_INCLUDED_TEMPLATE
      + REGEX_CMT_END;

<span class="fc" id="L68">  public static final Pattern VARIABLE = compile(REGEX_VARIABLE);</span>
<span class="fc" id="L69">  public static final Pattern CMT_VARIABLE = compile(REGEX_CMT_VARIABLE);</span>
<span class="fc" id="L70">  public static final Pattern INLINE_TEMPLATE</span>
<span class="fc" id="L71">      = compile(REGEX_INLINE_TEMPLATE, MULTILINE);</span>
<span class="fc" id="L72">  public static final Pattern CMT_INLINE_TEMPLATE</span>
<span class="fc" id="L73">      = compile(REGEX_CMT_INLINE_TEMPLATE, MULTILINE);</span>

<span class="fc" id="L75">  public static final Pattern INCLUDE_PATH = compile(REGEX_INCLUDE_PATH);</span>

<span class="fc" id="L77">  public static final Pattern INCLUDED_TEMPLATE = compile(REGEX_INCLUDED_TEMPLATE);</span>

<span class="fc" id="L79">  public static final Pattern CMT_INCLUDED_TEMPLATE = compile(REGEX_INCLUDED_TEMPLATE);</span>

  private static final String ERR_ILLEGAL_VAL = &quot;Illegal value for system property %s: \&quot;%s\&quot;&quot;;
  private static final String ERR_IDENTICAL = &quot;varStart and tmplStart must be different&quot;;

  public static final String VAR_START = &quot;~%&quot;;
  public static final String VAR_END = &quot;%&quot;;
  public static final String TMPL_START = &quot;~%%&quot;;
  public static final String TMPL_END = VAR_END;

  public static final String PLACEHOLDER_START_END = &quot;&lt;!--%--&gt;&quot;;

  private static Regex instance;

  public static Regex of() throws ParseException {
<span class="fc bfc" id="L94" title="All 2 branches covered.">    if (instance == null) {</span>
<span class="fc" id="L95">      return instance = new Regex();</span>
    }
<span class="fc" id="L97">    return instance;</span>
  }

  public final Pattern variable;
  public final Pattern cmtVariable;
  public final Pattern beginTag;
  public final Pattern endTag;
  public final Pattern inlineTemplate;
  public final Pattern cmtInlineTemplate;
  public final Pattern includedTemplate;
  public final Pattern cmtIncludedTemplate;
  public final Pattern ditchTag;
  public final Pattern ditchBlock;
  public final Pattern placeholder;

<span class="fc" id="L112">  private Regex() throws ParseException {</span>

<span class="fc" id="L114">    checkSysProps();</span>

<span class="fc" id="L116">    String vStart = quote(VAR_START);</span>
<span class="fc" id="L117">    String vEnd = quote(VAR_END);</span>
<span class="fc" id="L118">    String tStart = quote(TMPL_START);</span>
<span class="fc" id="L119">    String tEnd = quote(TMPL_END);</span>

<span class="fc" id="L121">    String name = &quot;([a-zA-Z0-9_\\.\\-]+)&quot;;</span>

<span class="fc" id="L123">    String cmtStart = &quot;&lt;!--\\s*&quot;;</span>

<span class="fc" id="L125">    String cmtEnd = &quot;\\s*--&gt;&quot;;</span>

    //String ptnVariable = vStart + &quot;(&quot; + name + &quot;:)?(.+?)&quot; + vEnd;
<span class="fc" id="L128">    String ptnVariable = &quot;~%(([a-zA-Z_]\\w*):)?([a-zA-Z0-9_\\.\\-]+)%&quot;;</span>
<span class="fc" id="L129">    String ptnCmtVariable = cmtStart + ptnVariable + cmtEnd;</span>

<span class="fc" id="L131">    String ptnInlineBegin = tStart + &quot;begin:&quot; + name + tEnd;</span>

<span class="fc" id="L133">    String ptnInlineEnd = tStart + &quot;end:&quot; + name + tEnd;</span>

<span class="fc" id="L135">    String ptnInlineTmpl = ptnInlineBegin + &quot;(.*?)&quot; + tStart + &quot;end:\\1&quot; + tEnd;</span>

<span class="fc" id="L137">    String ptnCmtInlineTmpl =</span>
        cmtStart
            + ptnInlineBegin
            + cmtEnd
            + &quot;(.*?)&quot;
            + cmtStart
            + tStart
            + &quot;end:\\1&quot;
            + tEnd
            + cmtEnd;

<span class="fc" id="L148">    String ptnIncludedTmpl = tStart + &quot;include:(&quot; + name + &quot;:)?(.+?)&quot; + tEnd;</span>

<span class="fc" id="L150">    String ptnCmtIncludedTmpl = cmtStart + ptnIncludedTmpl + cmtEnd;</span>

<span class="fc" id="L152">    String ptnDitchTag = &quot;&lt;!--%%(.*?)--&gt;&quot;;</span>

<span class="fc" id="L154">    String ptnDitchBlock = ptnDitchTag + &quot;(.*?)&quot; + ptnDitchTag;</span>

<span class="fc" id="L156">    String ptnPlaceholder = PLACEHOLDER_START_END + &quot;(.*?)&quot; + PLACEHOLDER_START_END;</span>

    // Equivalent to prefixing the regular expression with &quot;(?ms)&quot;
<span class="fc" id="L159">    int msModifiers = Pattern.MULTILINE | Pattern.DOTALL;</span>

<span class="fc" id="L161">    this.variable = compile(ptnVariable);</span>
<span class="fc" id="L162">    this.cmtVariable = compile(ptnCmtVariable);</span>
<span class="fc" id="L163">    this.beginTag = compile(ptnInlineBegin);</span>
<span class="fc" id="L164">    this.endTag = compile(ptnInlineEnd);</span>
<span class="fc" id="L165">    this.inlineTemplate = compile(ptnInlineTmpl, msModifiers);</span>
<span class="fc" id="L166">    this.cmtInlineTemplate = compile(ptnCmtInlineTmpl, msModifiers);</span>
<span class="fc" id="L167">    this.includedTemplate = compile(ptnIncludedTmpl);</span>
<span class="fc" id="L168">    this.cmtIncludedTemplate = compile(ptnCmtIncludedTmpl);</span>
<span class="fc" id="L169">    this.ditchTag = compile(ptnDitchTag);</span>
<span class="fc" id="L170">    this.ditchBlock = compile(ptnDitchBlock, msModifiers);</span>
<span class="fc" id="L171">    this.placeholder = compile(ptnPlaceholder, msModifiers);</span>
<span class="fc" id="L172">  }</span>

  private static void checkSysProps() throws ParseException {
<span class="fc" id="L175">    checkThat(VAR_START).isNot(blank(), ERR_ILLEGAL_VAL, VAR_START);</span>
<span class="fc" id="L176">    checkThat(VAR_END).isNot(blank(), ERR_ILLEGAL_VAL, VAR_END);</span>
<span class="fc" id="L177">    checkThat(TMPL_START)</span>
<span class="fc" id="L178">        .isNot(blank(), ERR_ILLEGAL_VAL, TMPL_START)</span>
<span class="fc" id="L179">        .isNot(EQ(), VAR_START, ERR_IDENTICAL);</span>
<span class="fc" id="L180">    checkThat(TMPL_END).isNot(blank(), ERR_ILLEGAL_VAL, TMPL_END);</span>
<span class="fc" id="L181">  }</span>

  public void printAll() {
<span class="fc" id="L184">    System.out.println(&quot;VARIABLE .......: &quot; + variable);</span>
<span class="fc" id="L185">    System.out.println(&quot;VARIABLE_CMT ...: &quot; + cmtVariable);</span>
<span class="fc" id="L186">    System.out.println(&quot;NESTED .........: &quot; + inlineTemplate);</span>
<span class="fc" id="L187">    System.out.println(&quot;NESTED_CMT .....: &quot; + cmtInlineTemplate);</span>
<span class="fc" id="L188">    System.out.println(&quot;INCLUDE ........: &quot; + includedTemplate);</span>
<span class="fc" id="L189">    System.out.println(&quot;INCLUDE_CMT ....: &quot; + cmtIncludedTemplate);</span>
<span class="fc" id="L190">    System.out.println(&quot;DITCH_BLOCK: ...: &quot; + ditchBlock);</span>
<span class="fc" id="L191">    System.out.println(&quot;PLACEHOLDER: ...: &quot; + placeholder);</span>
<span class="fc" id="L192">  }</span>

  private static ObjectCheck&lt;String, ParseException&gt; checkThat(String sysprop) {
<span class="fc" id="L195">    return Check.on(ParseException::new, sysprop);</span>
  }

  private static String quote(String token) {
<span class="fc" id="L199">    String special = &quot;\\^$.|?*+()[]{}&quot;;</span>
<span class="fc" id="L200">    Set&lt;Integer&gt; specialChars = special.codePoints().boxed().collect(toSet());</span>
<span class="fc" id="L201">    Set&lt;Integer&gt; tokenChars = token.codePoints().boxed().collect(toSet());</span>
<span class="pc bpc" id="L202" title="1 of 2 branches missed.">    return tokenChars.stream().anyMatch(specialChars::contains)</span>
<span class="nc" id="L203">        ? Pattern.quote(token)</span>
<span class="fc" id="L204">        : token;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>