<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Regex.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Klojang Templates</a> &gt; <a href="index.source.html" class="el_package">org.klojang.templates.x.parse</a> &gt; <span class="el_source">Regex.java</span></div><h1>Regex.java</h1><pre class="source lang-java linenums">package org.klojang.templates.x.parse;

import org.klojang.check.Check;
import org.klojang.check.ObjectCheck;
import org.klojang.templates.ParseException;
import org.klojang.templates.Setting;

import java.util.Set;
import java.util.regex.Pattern;

import static java.util.regex.Pattern.compile;
import static java.util.stream.Collectors.toSet;
import static org.klojang.check.CommonChecks.EQ;
import static org.klojang.check.CommonChecks.blank;

public final class Regex {

  private static final String ERR_ILLEGAL_VAL = &quot;Illegal value for system property %s: \&quot;%s\&quot;&quot;;
  private static final String ERR_IDENTICAL = &quot;varStart and tmplStart must be different&quot;;

<span class="fc" id="L21">  public static final String VAR_START = Setting.VAR_START.get();</span>

<span class="fc" id="L23">  public static final String VAR_END = Setting.VAR_END.get();</span>

<span class="fc" id="L25">  public static final String TMPL_START = Setting.TMPL_START.get();</span>
<span class="fc" id="L26">  public static final String TMPL_END = Setting.TMPL_END.get();</span>

  public static final String PLACEHOLDER_TAG = &quot;&lt;!--%--&gt;&quot;;

  private static Regex instance;

  static Regex of() throws ParseException {
<span class="fc bfc" id="L33" title="All 2 branches covered.">    if (instance == null) {</span>
<span class="fc" id="L34">      return instance = new Regex();</span>
    }
<span class="fc" id="L36">    return instance;</span>
  }

  final Pattern variable;
  final Pattern cmtVariable;
  final Pattern beginTag;
  final Pattern endTag;
  final Pattern inlineTemplate;
  final Pattern cmtInlineTemplate;
  final Pattern includedTemplate;
  final Pattern cmtIncludedTemplate;
  final Pattern ditchTag;
  final Pattern ditchBlock;
  final Pattern placeholder;

<span class="fc" id="L51">  private Regex() throws ParseException {</span>

<span class="fc" id="L53">    checkSysProps();</span>

<span class="fc" id="L55">    String vStart = quote(VAR_START);</span>
<span class="fc" id="L56">    String vEnd = quote(VAR_END);</span>
<span class="fc" id="L57">    String tStart = quote(TMPL_START);</span>
<span class="fc" id="L58">    String tEnd = quote(TMPL_END);</span>

    // Used for group name prefixes and template names, *not* for variable names
<span class="fc" id="L61">    String name = &quot;([a-zA-Z_]\\w*)&quot;;</span>

<span class="fc" id="L63">    String cmtStart = &quot;&lt;!--\\s*&quot;;</span>

<span class="fc" id="L65">    String cmtEnd = &quot;\\s*--&gt;&quot;;</span>

<span class="fc" id="L67">    String ptnVariable = vStart + &quot;(&quot; + name + &quot;:)?(.+?)&quot; + vEnd;</span>

<span class="fc" id="L69">    String ptnCmtVariable = cmtStart + ptnVariable + cmtEnd;</span>

<span class="fc" id="L71">    String ptnInlineBegin = tStart + &quot;begin:&quot; + name + tEnd;</span>

<span class="fc" id="L73">    String ptnInlineEnd = tStart + &quot;end:&quot; + name + tEnd;</span>

<span class="fc" id="L75">    String ptnInlineTmpl = ptnInlineBegin + &quot;(.*?)&quot; + tStart + &quot;end:\\1&quot; + tEnd;</span>

<span class="fc" id="L77">    String ptnCmtInlineTmpl =</span>
        cmtStart
            + ptnInlineBegin
            + cmtEnd
            + &quot;(.*?)&quot;
            + cmtStart
            + tStart
            + &quot;end:\\1&quot;
            + tEnd
            + cmtEnd;

<span class="fc" id="L88">    String ptnIncludedTmpl = tStart + &quot;include:(&quot; + name + &quot;:)?(.+?)&quot; + tEnd;</span>

<span class="fc" id="L90">    String ptnCmtIncludedTmpl = cmtStart + ptnIncludedTmpl + cmtEnd;</span>

<span class="fc" id="L92">    String ptnDitchTag = &quot;&lt;!--%%.*?--&gt;&quot;;</span>

<span class="fc" id="L94">    String ptnDitchBlock = ptnDitchTag + &quot;.*?&quot; + ptnDitchTag;</span>

<span class="fc" id="L96">    String ptnPlaceholder = PLACEHOLDER_TAG + &quot;.*?&quot; + PLACEHOLDER_TAG;</span>

    // Equivalent to prefixing the regular expression with &quot;(?ms)&quot;
<span class="fc" id="L99">    int msModifiers = Pattern.MULTILINE | Pattern.DOTALL;</span>

<span class="fc" id="L101">    this.variable = compile(ptnVariable);</span>
<span class="fc" id="L102">    this.cmtVariable = compile(ptnCmtVariable);</span>
<span class="fc" id="L103">    this.beginTag = compile(ptnInlineBegin);</span>
<span class="fc" id="L104">    this.endTag = compile(ptnInlineEnd);</span>
<span class="fc" id="L105">    this.inlineTemplate = compile(ptnInlineTmpl, msModifiers);</span>
<span class="fc" id="L106">    this.cmtInlineTemplate = compile(ptnCmtInlineTmpl, msModifiers);</span>
<span class="fc" id="L107">    this.includedTemplate = compile(ptnIncludedTmpl);</span>
<span class="fc" id="L108">    this.cmtIncludedTemplate = compile(ptnCmtIncludedTmpl);</span>
<span class="fc" id="L109">    this.ditchTag = compile(ptnDitchTag);</span>
<span class="fc" id="L110">    this.ditchBlock = compile(ptnDitchBlock, msModifiers);</span>
<span class="fc" id="L111">    this.placeholder = compile(ptnPlaceholder, msModifiers);</span>
<span class="fc" id="L112">  }</span>

  private static void checkSysProps() throws ParseException {
<span class="fc" id="L115">    checkThat(VAR_START).isNot(blank(), ERR_ILLEGAL_VAL, VAR_START);</span>
<span class="fc" id="L116">    checkThat(VAR_END).isNot(blank(), ERR_ILLEGAL_VAL, VAR_END);</span>
<span class="fc" id="L117">    checkThat(TMPL_START)</span>
<span class="fc" id="L118">        .isNot(blank(), ERR_ILLEGAL_VAL, TMPL_START)</span>
<span class="fc" id="L119">        .isNot(EQ(), VAR_START, ERR_IDENTICAL);</span>
<span class="fc" id="L120">    checkThat(TMPL_END).isNot(blank(), ERR_ILLEGAL_VAL, TMPL_END);</span>
<span class="fc" id="L121">  }</span>

  void printAll() {
<span class="fc" id="L124">    System.out.println(&quot;VARIABLE .......: &quot; + variable);</span>
<span class="fc" id="L125">    System.out.println(&quot;VARIABLE_CMT ...: &quot; + cmtVariable);</span>
<span class="fc" id="L126">    System.out.println(&quot;NESTED .........: &quot; + inlineTemplate);</span>
<span class="fc" id="L127">    System.out.println(&quot;NESTED_CMT .....: &quot; + cmtInlineTemplate);</span>
<span class="fc" id="L128">    System.out.println(&quot;INCLUDE ........: &quot; + includedTemplate);</span>
<span class="fc" id="L129">    System.out.println(&quot;INCLUDE_CMT ....: &quot; + cmtIncludedTemplate);</span>
<span class="fc" id="L130">    System.out.println(&quot;DITCH_BLOCK: ...: &quot; + ditchBlock);</span>
<span class="fc" id="L131">    System.out.println(&quot;PLACEHOLDER: ...: &quot; + placeholder);</span>
<span class="fc" id="L132">  }</span>

  private static ObjectCheck&lt;String, ParseException&gt; checkThat(String sysprop) {
<span class="fc" id="L135">    return Check.on(ParseException::new, sysprop);</span>
  }

  private static String quote(String token) {
<span class="fc" id="L139">    String special = &quot;\\^$.|?*+()[]{}&quot;;</span>
<span class="fc" id="L140">    Set&lt;Integer&gt; specialChars = special.codePoints().boxed().collect(toSet());</span>
<span class="fc" id="L141">    Set&lt;Integer&gt; tokenChars = token.codePoints().boxed().collect(toSet());</span>
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">    return tokenChars.stream().anyMatch(specialChars::contains)</span>
<span class="nc" id="L143">        ? Pattern.quote(token)</span>
<span class="fc" id="L144">        : token;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>